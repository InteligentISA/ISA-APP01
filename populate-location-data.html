<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Populate Location Data</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Populate Location Data</h1>
    <div id="status">Click the button below to populate location data...</div>
    <button onclick="populateData()">Populate Location Data</button>
    <div id="results"></div>

    <script>
        // Replace with your actual Supabase URL and anon key
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const locationData = [
            {
                name: "Nairobi County",
                is_hotspot: true,
                constituencies: [
                    {
                        name: "Westlands",
                        wards: [
                            { name: "Kitisuru" },
                            { name: "Parklands/Highridge" },
                            { name: "Karura" },
                            { name: "Kangemi" },
                            { name: "Mountain View" }
                        ]
                    },
                    {
                        name: "Dagoretti North",
                        wards: [
                            { name: "Kilimani" },
                            { name: "Kawangware" },
                            { name: "Gatina" },
                            { name: "Kileleshwa" },
                            { name: "Kabiro" }
                        ]
                    },
                    {
                        name: "Dagoretti South",
                        wards: [
                            { name: "Mutu-Ini" },
                            { name: "Ngando" },
                            { name: "Riruta" },
                            { name: "Uthiru/Ruthimitu" },
                            { name: "Waithaka" }
                        ]
                    },
                    {
                        name: "Lang'ata",
                        wards: [
                            { name: "Karen" },
                            { name: "Nairobi West" },
                            { name: "Mugumu-Ini" },
                            { name: "South C" },
                            { name: "Nyayo Highrise" }
                        ]
                    },
                    {
                        name: "Kibra",
                        wards: [
                            { name: "Woodley/Kenyatta Golf Course" },
                            { name: "Sarang'ombe" },
                            { name: "Makina" },
                            { name: "Lindi" },
                            { name: "Laini Saba" }
                        ]
                    }
                ]
            },
            {
                name: "Kiambu County",
                is_hotspot: true,
                constituencies: [
                    {
                        name: "Thika Town",
                        wards: [
                            { name: "Township" },
                            { name: "Kamenu" },
                            { name: "Hospital" },
                            { name: "Gatuanyaga" },
                            { name: "Ngoliba" }
                        ]
                    },
                    {
                        name: "Ruiru",
                        wards: [
                            { name: "Gitothua" },
                            { name: "Biashara" },
                            { name: "Gatongora" },
                            { name: "Kahawa Sukari" },
                            { name: "Kahawa Wendani" }
                        ]
                    }
                ]
            },
            {
                name: "Machakos County",
                is_hotspot: true,
                constituencies: [
                    {
                        name: "Machakos Town",
                        wards: [
                            { name: "Kalama" },
                            { name: "Mua" },
                            { name: "Mutitini" },
                            { name: "Machakos Central" },
                            { name: "Mumbuni North" }
                        ]
                    }
                ]
            },
            {
                name: "Kajiado County",
                is_hotspot: true,
                constituencies: [
                    {
                        name: "Kajiado North",
                        wards: [
                            { name: "Olkeri" },
                            { name: "Ongata Rongai" },
                            { name: "Nkaimurunya" },
                            { name: "Oloolua" },
                            { name: "Ngong" }
                        ]
                    }
                ]
            }
        ];

        async function populateData() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.textContent = 'üöÄ Starting location data population...';
                
                // Clear existing data
                await supabase.from('delivery_ward_costs').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('delivery_constituency_costs').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('delivery_county_costs').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('wards').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('constituencies').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('counties').delete().neq('id', '00000000-0000-0000-0000-000000000000');

                // Insert counties
                const countiesToInsert = locationData.map(county => ({
                    name: county.name,
                    is_hotspot: county.is_hotspot
                }));

                const { data: insertedCounties, error: countiesError } = await supabase
                    .from('counties')
                    .insert(countiesToInsert)
                    .select('id, name, is_hotspot');

                if (countiesError) {
                    throw new Error('Error inserting counties: ' + countiesError.message);
                }

                console.log(`‚úÖ Inserted ${insertedCounties?.length || 0} counties`);

                // Create county map
                const countyMap = new Map();
                insertedCounties?.forEach(county => {
                    countyMap.set(county.name, county.id);
                });

                // Insert constituencies
                const constituenciesToInsert = [];
                
                for (const county of locationData) {
                    const countyId = countyMap.get(county.name);
                    if (!countyId) continue;

                    for (const constituency of county.constituencies) {
                        constituenciesToInsert.push({
                            name: constituency.name,
                            county_id: countyId
                        });
                    }
                }

                const { data: insertedConstituencies, error: constituenciesError } = await supabase
                    .from('constituencies')
                    .insert(constituenciesToInsert)
                    .select('id, name, county_id');

                if (constituenciesError) {
                    throw new Error('Error inserting constituencies: ' + constituenciesError.message);
                }

                console.log(`‚úÖ Inserted ${insertedConstituencies?.length || 0} constituencies`);

                // Create constituency map
                const constituencyMap = new Map();
                insertedConstituencies?.forEach(constituency => {
                    const key = `${constituency.county_id}-${constituency.name}`;
                    constituencyMap.set(key, constituency.id);
                });

                // Insert wards (only for hotspot areas)
                const wardsToInsert = [];
                
                for (const county of locationData) {
                    if (!county.is_hotspot) continue;

                    const countyId = countyMap.get(county.name);
                    if (!countyId) continue;

                    for (const constituency of county.constituencies) {
                        const constituencyId = constituencyMap.get(`${countyId}-${constituency.name}`);
                        if (!constituencyId) continue;

                        for (const ward of constituency.wards) {
                            wardsToInsert.push({
                                name: ward.name,
                                constituency_id: constituencyId
                            });
                        }
                    }
                }

                if (wardsToInsert.length > 0) {
                    const { data: insertedWards, error: wardsError } = await supabase
                        .from('wards')
                        .insert(wardsToInsert)
                        .select('id, name, constituency_id');

                    if (wardsError) {
                        throw new Error('Error inserting wards: ' + wardsError.message);
                    }

                    console.log(`‚úÖ Inserted ${insertedWards?.length || 0} wards`);
                }

                // Set up default delivery costs
                await supabase
                    .from('delivery_base_cost')
                    .upsert({
                        base_cost: 200.00,
                        is_active: true
                    });

                console.log('‚úÖ Set base delivery cost to Ksh 200');

                // Set up county-to-county costs (simplified - all counties cost 100 to each other)
                const countyCosts = [];
                for (const fromCounty of insertedCounties || []) {
                    for (const toCounty of insertedCounties || []) {
                        if (fromCounty.id !== toCounty.id) {
                            countyCosts.push({
                                from_county_id: fromCounty.id,
                                to_county_id: toCounty.id,
                                cost: 100.00,
                                is_active: true
                            });
                        }
                    }
                }

                if (countyCosts.length > 0) {
                    await supabase.from('delivery_county_costs').insert(countyCosts);
                    console.log(`‚úÖ Set up ${countyCosts.length} county-to-county delivery costs`);
                }

                statusDiv.textContent = 'üéâ Location data population completed successfully!';
                resultsDiv.innerHTML = `
                    <h3>üìä Summary:</h3>
                    <ul>
                        <li>Counties: ${insertedCounties?.length || 0}</li>
                        <li>Constituencies: ${insertedConstituencies?.length || 0}</li>
                        <li>Wards: ${wardsToInsert.length}</li>
                        <li>County Costs: ${countyCosts.length}</li>
                    </ul>
                `;

            } catch (error) {
                console.error('‚ùå Error populating location data:', error);
                statusDiv.textContent = '‚ùå Error: ' + error.message;
                resultsDiv.innerHTML = '<p style="color: red;">Check the console for more details.</p>';
            }
        }
    </script>
</body>
</html>
